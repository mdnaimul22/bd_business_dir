{% extends 'base.html' %}

{% block title %}{% if action == 'add' %}{{ _('Add New Shop') }}{% else %}{{ _('Edit Shop') }}{% endif %} - {{
_('Bangladesh Engineering Workshop') }}{% endblock %}

{% block content %}
<section class="shop-form-section">
    <h1 style="margin-bottom: 1.5rem;">
        {% if action == 'add' %}
        ‚ûï {{ _('Add New Shop') }}
        {% else %}
        ‚úèÔ∏è {{ _('Edit Shop') }}
        {% endif %}
    </h1>

    <form method="POST" class="shop-form" enctype="multipart/form-data">

        <!-- Row 1: Shop Name & Visiting Card Section -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <!-- Left: Shop Name -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="name">üè™ {{ _('Shop Name') }}</label>
                <input type="text" name="name" id="name" class="form-control" required value="{{ shop.name or '' }}"
                    placeholder="{{ _('Enter shop name') }}">
            </div>

            <!-- Right: Visiting Card with Preview -->
            <div style="display: flex; gap: 1rem; align-items: flex-start;">
                <div class="form-group" style="flex: 0 0 160px; margin-bottom: 0;">
                    <label for="visiting_card" style="font-size: 0.8rem;">üñºÔ∏è Visiting Card</label>
                    <input type="file" name="visiting_card" id="visiting_card" class="form-control" accept="image/*"
                        onchange="previewImage(this)" style="font-size: 0.75rem; padding: 0.35rem 0.5rem;">
                </div>
                <div id="imagePreview"
                    style="width: 250px; height: 120px; background: #f5f5f5; border-radius: 6px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; margin-top: -50px;">
                    {% if shop.visiting_card %}
                    <img src="/shop_img/{{ shop.visiting_card }}" alt="Current Card"
                        style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                    {% else %}
                    <span style="color: #999; font-size: 10px;">‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Row 2: Proprietor & Category -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="proprietor">üë§ {{ _('Proprietor') }}</label>
                <input type="text" name="proprietor" id="proprietor" class="form-control"
                    value="{{ shop.proprietor or '' }}" placeholder="{{ _('Proprietor Name') }}">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label for="category_id">üìÇ {{ _('Category') }}</label>
                <select name="category_id" id="category_id" class="form-control">
                    <option value="">-- {{ _('Select Category') }} --</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if shop.category_id==cat.id %}selected{% endif %}>
                        {{ cat.name }} ({{ cat.name_english }})
                    </option>
                    {% endfor %}
                    <option value="new">+ {{ _('Add New Category') }}</option>
                </select>
                <input type="text" name="new_category_name" id="new_category_name" class="form-control"
                    placeholder="{{ _('Enter new category name') }}" style="display: none; margin-top: 0.5rem;">
            </div>
        </div>

        <!-- Row 3: Address & Mobile -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="address">üìç {{ _('Address') }}</label>
                <input type="text" name="address" id="address" class="form-control" value="{{ shop.address or '' }}"
                    placeholder="{{ _('Shop Address') }}">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label for="mobile">üì± {{ _('Mobile') }}</label>
                <input type="text" name="mobile" id="mobile" class="form-control" value="{{ shop.mobile or '' }}"
                    placeholder="{{ _('e.g. 017XX-XXXXXX') }}">
            </div>
        </div>

        <!-- Row 4: WhatsApp & Online Transaction -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="whatsapp">üí¨ {{ _('WhatsApp') }}</label>
                <input type="text" name="whatsapp" id="whatsapp" class="form-control" value="{{ shop.whatsapp or '' }}"
                    placeholder="{{ _('WhatsApp Number') }}">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label for="transaction_status">üí∞ {{ _('Online Transaction') }}</label>
                <input type="text" name="transaction_status" id="transaction_status" class="form-control"
                    value="{{ shop.transaction_status or '' }}" placeholder="{{ _('e.g. Bkash 018XX-XXXXXX') }}">
            </div>
        </div>

        <!-- Row 5: Email/Web (Full Width) -->
        <div style="margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="email_web">üìß {{ _('Email/Web') }}</label>
                <input type="text" name="email_web" id="email_web" class="form-control"
                    value="{{ shop.email_web or '' }}" placeholder="{{ _('Email or Website') }}">
            </div>
        </div>

        <!-- Row 6: Products List (Full Width) -->
        <div style="margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="products">üì¶ {{ _('Products List') }}</label>
                <textarea name="products" id="products" class="form-control" rows="4"
                    placeholder="{{ _('Products available in this shop...') }}">{{ shop.products or '' }}</textarea>
            </div>
        </div>

        <!-- Row 7: Tags (Full Width) - For Search Engine -->
        <div style="margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label>üè∑Ô∏è {{ _('Tags') }} <span style="font-size: 0.8rem; color: #666; font-weight: normal;">({{
                        _('separate with comma') }})</span></label>

                <!-- Tags Container - Added tags appear here -->
                <div id="tags-container" style="margin-top: 0.5rem; margin-bottom: 0.75rem;">
                    {% if action == 'edit' and shop.tags %}
                    {% for tag in shop.tags %}
                    <div class="tag-item" data-tag-id="{{ tag.id }}"
                        style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; margin-bottom: 0.4rem; background: linear-gradient(135deg, #e0f2fe, #bae6fd); border-radius: 8px; max-width: 400px;">
                        <span style="flex: 1; color: #0284c7; font-weight: 500;">üè∑Ô∏è {{ tag.name }}</span>
                        <button type="button" class="btn-remove-tag" data-tag-id="{{ tag.id }}"
                            style="background: #fee2e2; color: #dc2626; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;"
                            title="‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡¶∞‡¶æ‡¶®">√ó</button>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                <!-- Add Tag Input -->
                <div style="display: flex; gap: 0.5rem; align-items: center; max-width: 400px;">
                    <input type="text" id="new-tag-input" class="form-control"
                        placeholder="{{ _('e.g. Lathe, Shaft, Bush, ‡¶≤‡ßá‡¶¶') }}" style="flex: 1;">
                    <button type="button" id="btn-add-tag" class="btn btn-primary"
                        style="padding: 0.5rem 1rem; white-space: nowrap;">
                        ‚ûï {{ _('Add Tag') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="form-actions" style="margin-top: 1rem;">
            <button type="submit" class="btn btn-primary btn-lg">
                {% if action == 'add' %}
                ‚ûï {{ _('Add Shop') }}
                {% else %}
                üíæ {{ _('Save') }}
                {% endif %}
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">{{ _('Cancel') }}</a>
        </div>
    </form>
</section>

<script>
    // Shop ID for edit mode (null for add mode)
    const SHOP_ID = {% if action == 'edit' and shop_id %}{ { shop_id } } {% else %} null{% endif %};
    const IS_EDIT_MODE = SHOP_ID !== null;

    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.innerHTML = '<img src="' + e.target.result + '" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Handle new category input
    document.getElementById('category_id').addEventListener('change', function () {
        var newCatInput = document.getElementById('new_category_name');
        if (this.value === 'new') {
            newCatInput.style.display = 'block';
            newCatInput.focus();
        } else {
            newCatInput.style.display = 'none';
        }
    });

    // ==================== SIMPLE TAG MANAGEMENT ====================

    // Add a tag item to the container (visual only if not in edit mode)
    function addTagToContainer(tagId, tagName) {
        const container = document.getElementById('tags-container');

        const tagItem = document.createElement('div');
        tagItem.className = 'tag-item';
        tagItem.dataset.tagId = tagId;
        tagItem.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; margin-bottom: 0.4rem; background: linear-gradient(135deg, #e0f2fe, #bae6fd); border-radius: 8px; max-width: 400px;';
        tagItem.innerHTML = `
            <span style="flex: 1; color: #0284c7; font-weight: 500;">üè∑Ô∏è ${tagName}</span>
            <button type="button" class="btn-remove-tag" data-tag-id="${tagId}" 
                style="background: #fee2e2; color: #dc2626; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;"
                title="‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡¶∞‡¶æ‡¶®">√ó</button>
        `;

        container.appendChild(tagItem);

        // Add remove handler
        tagItem.querySelector('.btn-remove-tag').addEventListener('click', handleRemoveTag);
    }

    // Handle add tag button click
    // Handle add tag button click
    document.getElementById('btn-add-tag').addEventListener('click', async function () {
        const input = document.getElementById('new-tag-input');
        const rawInput = input.value.trim();

        if (!rawInput) {
            alert('‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®');
            return;
        }

        if (!IS_EDIT_MODE) {
            alert('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            return;
        }

        const tags = rawInput.split(',').map(t => t.trim()).filter(t => t);

        for (const tagName of tags) {
            try {
                // First create the tag (or get existing)
                const createResponse = await fetch('/api/tag/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: tagName, name_bn: '' })
                });

                if (!createResponse.ok) {
                    console.error('Failed to create tag: ' + tagName);
                    continue;
                }

                const tagData = await createResponse.json();

                // Then add it to the shop
                const addResponse = await fetch(`/api/shop/${SHOP_ID}/tag/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag_id: tagData.id })
                });

                if (addResponse.ok) {
                    // Check if already in UI to avoid duplicates
                    const existing = document.querySelector(`.tag-item[data-tag-id="${tagData.id}"]`);
                    if (!existing) {
                        addTagToContainer(tagData.id, tagName);
                    }
                }
            } catch (err) {
                console.error('Error adding tag: ' + tagName, err);
            }
        }

        input.value = '';
        input.focus();
    });

    // Allow Enter key to add tag
    document.getElementById('new-tag-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('btn-add-tag').click();
        }
    });

    // Handle remove tag
    async function handleRemoveTag(e) {
        const tagId = e.target.dataset.tagId;
        const tagItem = e.target.closest('.tag-item');

        if (!IS_EDIT_MODE) {
            tagItem.remove();
            return;
        }

        try {
            const response = await fetch(`/api/shop/${SHOP_ID}/tag/remove`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tag_id: tagId })
            });

            if (response.ok) {
                tagItem.remove();
            } else {
                alert('‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡¶∞‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            }
        } catch (err) {
            alert('‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶∏‡¶∞‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
        }
    }

    // Attach remove handlers to existing tags
    document.querySelectorAll('.btn-remove-tag').forEach(btn => {
        btn.addEventListener('click', handleRemoveTag);
    });
</script>
{% endblock %}